var ROOT,Helper;!function(a){function b(a,b){ROOT[a]=b}function c(){ROOT="undefined"!=typeof module&&module.exports?global:window}a.setModule=b,c(),b("setModule",b)}(Helper||(Helper={}));var Matrix;!function(a){var b=function(){function a(a,b,c){if(this.d1=a,this.d2=b,this.arr_length=0,this.arr_length=this.d1*this.d2,this.arr=new Array(this.arr_length),c===c)for(var d=0;d<this.arr_length;++d)this.arr[d]=c}return a.generateMatrix=function(b,c,d){if(b.length!==c*d)throw"Dimensions do not agree with given array!";var e=new a(c,d);return e.setArray(b),e},a.copyMatrix=function(b){for(var c=b.dim(),d=new a(c.d1,c.d2),e=0;e<c.d1;++e)for(var f=0;f<c.d2;++f){var g=b.get(e,f);if("number"==typeof g)d.set(e,f,g);else{if(!Array.isArray(g))throw"Unsupported matrix field type!";d.set(e,f,g.slice(0))}}return d},a.prototype.getArray=function(){return this.arr},a.prototype.setArray=function(a){this.arr=a},a.prototype.dim=function(){return{d1:this.d1,d2:this.d2}},a.prototype.length=function(){return this.arr_length},a.prototype.get=function(a,b){var c=b*this.d1+a;if(c>=this.length())throw"Index out of bounds";return this.arr[c]},a.prototype.getIndex=function(a,b){return b*this.d1+a},a.prototype.set=function(a,b,c){var d=b*this.d1+a;if(d>=this.length())throw"Index out of bounds";this.arr[d]=c},a.prototype.add=function(b){var c=b.dim();if(this.d1!==c.d1||this.d2!==c.d2)throw"Refusing to add 2 matrices of different dimensions!";for(var d=new a(this.d1,this.d2),e=0;e<this.d1;++e)for(var f=0;f<this.d2;++f)d.set(e,f,this.get(e,f)+b.get(e,f));return d},a.prototype.sub=function(b){var c=b.dim();if(this.d1!==c.d1||this.d2!==c.d2)throw"Refusing to add 2 matrices of different dimensions!";for(var d=new a(this.d1,this.d2),e=0;e<this.d1;++e)for(var f=0;f<this.d2;++f)d.set(e,f,this.get(e,f)-b.get(e,f));return d},a.prototype.mult=function(b){var c=b.dim();if(this.d1!==c.d2)throw"Dimensions do now allow multiplication; refusing!";for(var d=new a(c.d1,this.d2),e=0;e<this.d2;++e)for(var f=0;f<c.d1;++f){for(var g=0,h=0;h<this.d1;++h)g+=this.get(h,e)*b.get(f,h);d.set(f,e,g)}return d},a.prototype.getNeighbors=function(a,b,c){"undefined"==typeof c&&(c=!1);for(var d,e,f,g,h=this.d1,i=this.d2,j=[],k=-1;2>k;k++)if(!(0>a+k||a+k>=h))for(var l=-1;2>l;l++)if(!(0>b+l||b+l>=i||0==l&&0==k))if(c)if(d=this.get(a,b),"number"==typeof d)j.push([a+k,b+l,Math.abs(this.get(a,b)-this.get(a+k,b+l))]);else{if(!Array.isArray(d))throw"Unsupported Matrix field type!";e=.2126*d[0]+.7152*d[1]+.0722*d[2],g=this.get(a+k,b+l),f=.2126*g[0]+.7152*g[1]+.0722*g[2],j.push([a+k,b+l,Math.abs(e-f)])}else j.push([a+k,b+l,this.get(a+k,b+l)]);return j},a.prototype.toString=function(){console.log("Matrix representation:\n");for(var a=0;a<this.d2;++a){process.stdout.write("[");for(var b=0;b<this.d1;++b)process.stdout.write(this.get(b,a)+" ");console.log("]")}},a}();a.Matrix2D=b,setModule("Matrix",a)}(Matrix||(Matrix={}));var DJSet;!function(a){var b=function(){function a(a){this.size=a,this.parents=new Array(a),this.ranks=new Array(a);for(var b=0;a>b;++b)this.parents[b]=b,this.ranks[b]=0}return a.prototype.getSize=function(){return this.size},a.prototype.find=function(a){var b=this.parents[a];return b===a?b:this.find(b)},a.prototype.union=function(a,b){this.ranks[a]>this.ranks[b]?this.parents[b]=a:this.ranks[b]>this.ranks[a]?this.parents[a]=b:(this.parents[b]=a,this.ranks[a]++)},a.prototype.rank=function(a){return this.ranks[a]},a.prototype.parent=function(a){return this.parents[a]},a}();a.DisjointSet=b,setModule("DJSet",a)}(DJSet||(DJSet={}));var M2D=Matrix.Matrix2D,Images;!function(a){var b=function(){function a(a,b,c){if(this.width=a,this.height=b,c.length!==a*b*4)throw"Invalid dimensions or array length";this.matrix=new M2D(a,b);for(var d=0;a>d;++d)for(var e=0;b>e;++e){var f=4*(e*a+d),g=[c[f],c[f+1],c[f+2]];this.matrix.set(d,e,g)}}return a.prototype.getArray=function(){return this.matrix.getArray()},a.prototype.toRgbaArray=function(){for(var a=new Array(this.width*this.height*4),b=this.matrix.getArray(),c=0,d=0;d<a.length;++d)d%4===3?(++c,a[d]=1):a[d]=b[d-c];return a},a.prototype.toGrayImage=function(){return new c(this.width,this.height,this.toRgbaArray())},a}();a.RgbImage=b;var c=function(){function a(a,b,c){if(this.width=a,this.height=b,c.length!==a*b*4)throw"Invalid dimensions or array length";this.matrix=new M2D(a,b);for(var d=0;a>d;++d)for(var e=0;b>e;++e){var f=4*(e*a+d),g=.2126*c[f]+.7152*c[f+1]+.0722*c[f+2];this.matrix.set(d,e,g)}}return a.prototype.getArray=function(){return this.matrix.getArray()},a.prototype.getPixelIndex=function(a,b){return this.matrix.getIndex(a,b)},a.prototype.toRgbaArray=function(){for(var a=new Uint8ClampedArray(this.width*this.height*4),b=this.matrix.getArray(),c=0,d=0;d<b.length;++d)a[c]=a[c+1]=a[c+2]=b[d],a[c+3]=255,c+=4;return a},a.prototype.fillRgbaArray=function(a){for(var b=this.matrix.getArray(),c=0,d=0;d<b.length;++d)a[c]=a[c+1]=a[c+2]=b[d],a[c+3]=255,c+=4},a.prototype.computeAdjacencyList=function(a){for(var b=new Matrix.Matrix2D(this.width,this.height),c=0;c<this.width;++c)for(var d=0;d<this.height;++d)b.set(c,d,this.matrix.getNeighbors(c,d,a));return b},a}();a.GrayImage=c,setModule("Images",a)}(Images||(Images={}));var M2D=Matrix.Matrix2D,Graphs;!function(a){var b=function(){function a(a,b,c){this.adj_list=a,this.edge_list=this.computeEdgeList(),b&&this.sort(c)}return a.prototype.sort=function(a){"undefined"==typeof a&&(a=!0);var b;b=a?function(a,b){return a.w-b.w}:function(a,b){return b.w-a.w},this.edge_list.sort(b)},a.prototype.computeEdgeList=function(){for(var a,b,c,d=this.adj_list,e=d.dim(),f=new Matrix.Matrix2D(e.d1,e.d2,0),g=new Array,h=0;h<e.d1;++h)for(var i=0;i<e.d2;++i){f.set(h,i,1),a=d.get(h,i);for(var j=0;j<a.length;++j)b=a[j],f.get(b[0],b[1])||(c={p1:[h,i],p2:[b[0],b[1]],w:b[2]},g.push(c))}return g},a}();a.Graph=b,setModule("Graphs",a)}(Graphs||(Graphs={}));var M2D=Matrix.Matrix2D,Regions;if(function(a){var b=function(){function a(a,b,d){this.regions={},this.labels=new M2D(a,b);for(var e,f,g,h=this.labels.getArray(),i=d.getArray(),j=0;j<h.length;++j)h[j]=j,g=new c(j),g.size=1,g.avg_color=i[j],e=j%a>>>0,f=j/a>>>0,g.centroid=[e,f],this.regions[j]=g}return a.prototype.merge=function(a,b,c){a.maxEdge=c.w,a.avg_color=(a.avg_color*a.size+b.avg_color*b.size)/(a.size+b.size)|0;var d=a.size+b.size;a.centroid[0]=(a.centroid[0]*a.size+b.centroid[0]*b.size)/d,a.centroid[1]=(a.centroid[1]*a.size+b.centroid[1]*b.size)/d,a.size=d,b.deleted=!0},a.prototype.getRegion=function(a){var b=this.labels.get(a[0],a[1]);return this.regions[b]},a.prototype.getRegionByIndex=function(a){return this.regions[a]},a}();a.RegionMap=b;var c=function(){function a(a){this.id=a,this.size=0,this.avg_color=0,this.centroid=[],this.maxEdge=0,this.pixels=[],this.labelColor=[],this.deleted=!1}return a}();a.Region=c,setModule("Regions",a)}(Regions||(Regions={})),"undefined"!=typeof window&&null!==window){var k_thres=document.querySelector("#k-threshold").value;window.k=k_thres,document.querySelector("#k-threshold-info").textContent=k_thres;var size_thres=document.querySelector("#size-threshold").value;window.threshold=size_thres,document.querySelector("#size-threshold-info").textContent=size_thres;var region_max_merge_size=document.querySelector("#max-merge").value;window.region_max_merge_size=region_max_merge_size,document.querySelector("#max-merge-info").textContent=region_max_merge_size}var updateProgress=function(a){var b=(new Date).getTime()-start,c=a+" 	 :	 "+b+"ms";console.log(c),document.querySelector("#progress").textContent=c},getGlobals=function(){window.canvas=document.querySelector("#img_canvas"),window.width=canvas.width,window.height=canvas.height,window.ctx=canvas.getContext("2d"),window.img=ctx.getImageData(0,0,width,height),window.regionCanvas=document.querySelector("#region_canvas"),window.rctx=regionCanvas.getContext("2d"),window.rImg=rctx.getImageData(0,0,width,height),window.delcan=document.querySelector("#delaunay_canvas"),window.delctx=delcan.getContext("2d"),window.vertices=[],window.vertices_map={},window.triangles=[],window.outGraph={},window.start=(new Date).getTime()},demoGrayScale=function(){window.start=(new Date).getTime(),getGlobals();var a=new Images.GrayImage(canvas.width,canvas.height,img.data),b=(a.fillRgbaArray(img.data),(new Date).getTime()-start);console.log("Execution time: "+b+"ms"),ctx.putImageData(img,0,0)},demoAdjacencyList=function(){delete window.grayImg,delete window.adj_list;var a=(new Date).getTime();getGlobals(),window.grayImg=new Images.GrayImage(canvas.width,canvas.height,img.data),window.adj_list=grayImg.computeAdjacencyList(!0);var b=adj_list.dim();console.log("Adjacency List dimensions: "+b.d1+", "+b.d2);var c=(new Date).getTime()-a;console.log("Execution time: "+c+"ms")},demoEdgeListComputation=function(){delete window.graph;var a=(new Date).getTime();getGlobals();var b=new Images.GrayImage(canvas.width,canvas.height,img.data),c=b.computeAdjacencyList(!0);window.graph=new Graphs.Graph(c);var d=(new Date).getTime()-a;console.log("Execution time: "+d+"ms")},startRegionMerging=function(){delete window.grayImg,delete window.adj_list,delete window.graph,delete window.rMap,delete window.djs,getGlobals(),rctx.clearRect(0,0,width,height),delctx.clearRect(0,0,width,height),document.querySelector("#region_canvas").style.backgroundImage="url(/imgextract/images/loading.gif)",document.querySelector("#progress").textContent="Processing Image... this might take some time...",setTimeout(function(){demoRegionMerging()},50)},demoRegionMerging=function(){window.grayImg=new Images.GrayImage(width,height,img.data);var a="Converted to Gray Image...";updateProgress(a),window.adj_list=grayImg.computeAdjacencyList(!0),a="Constructed Adjacency List...",updateProgress(a),window.graph=new Graphs.Graph(adj_list,!0),a="Instantiated original Graph...",updateProgress(a),window.rMap=new Regions.RegionMap(width,height,grayImg),window.djs=new DJSet.DisjointSet(width*height),a="Constructed Region Map...\n STARTING REGION MERGING...",updateProgress(a);for(var b,c,d,e,f,g,h,i,j,l,m=graph.edge_list,n=0,o=0;o<m.length;++o)h=m[o],b=grayImg.getPixelIndex(h.p1[0],h.p1[1]),c=grayImg.getPixelIndex(h.p2[0],h.p2[1]),d=djs.find(b),e=djs.find(c),f=rMap.getRegionByIndex(d),g=rMap.getRegionByIndex(e),d===e||f.size+g.size>region_max_merge_size||(i=k/f.size,j=k/g.size,l=Math.min(f.maxEdge+i,g.maxEdge+j),l>h.w&&(djs.union(d,e),djs.rank(d)>djs.rank(e)?rMap.merge(f,g,h):rMap.merge(g,f,h),++n));var p=width*height-n;for(a="Merged "+n+" regions... \n"+p+" regions remain.",updateProgress(a),o=0;width*height*4>o;o+=4){var q=rMap.getRegionByIndex(djs.find(o/4));q.size<threshold?(rImg.data[o]=255,rImg.data[o+1]=255,rImg.data[o+2]=255,rImg.data[o+3]=255):(3!==q.labelColor.length&&(q.labelColor[0]=256*Math.random()|0,q.labelColor[1]=256*Math.random()|0,q.labelColor[2]=256*Math.random()|0),rImg.data[o]=q.labelColor[0],rImg.data[o+1]=q.labelColor[1],rImg.data[o+2]=q.labelColor[2],rImg.data[o+3]=255)}rctx.putImageData(rImg,0,0);var r,s,t=Object.keys(rMap.regions),u=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY,w=0,x=0;for(o=0;o<t.length;++o)r=rMap.regions[t[o]],u=u>r.size?r.size:u,v=v<r.size?r.size:v,!r.deleted&&r.size<threshold?++w:!r.deleted&&r.size>=threshold&&(s=[0|r.centroid[0],0|r.centroid[1]],vertices[x]=s,vertices_map[x++]=r);for(a="Regions vary in size from: "+u+" to "+v+" pixels\nThere are: "+w+" regions below the size threshold of "+threshold,updateProgress(a),triangles=Delaunay.triangulate(vertices),delctx.clearRect(0,0,canvas.width,canvas.height),o=triangles.length;o;)delctx.beginPath(),--o,delctx.moveTo(vertices[triangles[o]][0],vertices[triangles[o]][1]),--o,delctx.lineTo(vertices[triangles[o]][0],vertices[triangles[o]][1]),--o,delctx.lineTo(vertices[triangles[o]][0],vertices[triangles[o]][1]),delctx.closePath(),delctx.stroke();var q,y;for(o=0;o<triangles.length-1;)y=triangles[o],q=vertices_map[y],"undefined"==typeof outGraph[y]&&(outGraph[y]={node:y,coords:{x:q.centroid[0],y:q.centroid[1],z:q.avg_color},features:{},edges:[]}),outGraph[y].edges.push(triangles[++o]);document.querySelector("#region_canvas").style.backgroundImage=null,document.querySelector("#img_regions .value").textContent=vertices.length,a="Graph with "+vertices.length+" vertices written! FINISHED in ",updateProgress(a)};